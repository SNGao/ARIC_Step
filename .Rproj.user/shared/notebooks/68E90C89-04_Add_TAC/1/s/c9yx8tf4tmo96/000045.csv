"0","folder.name = '$01_ARIC_TAC/'"
"0","files = list.files(folder.name) # Num=1394"
"0","files.steps = list.files('$03_Regenerate.steps.day/')"
"0",""
"0","err.files = data.frame(subjectid = NA,"
"0","                       error = NA)"
"0",""
"0","# Summarize TAC, valid signal and steps"
"0","for (file in files){"
"0","  ## generate daily steps"
"0","  dat.TAC = readRDS(paste0(folder.name, file)) |>"
"0","    mutate(VM_mean = VM_mean*60) # VM_mean: average TAC in one second"
"0","  # check the completeness of TAC"
"0","  if (!is_wholenumber(dim(dat.TAC)[1]/1440)){"
"0","    err.files = rbind(err.files,"
"0","                      data.frame(subjectid = file, "
"0","                                 error = 'not a multiple of 1440 (number of minutes in a day)'))"
"0","    next"
"0","  }"
"0","  dat.TAC$minute = as.POSIXct(strptime(dat.TAC$minute, format=""%Y-%m-%d %H:%M:%S"", tz=""UTC""))"
"0",""
"0","  # Add missing timestamp"
"0","  dat.TAC = dat.TAC |>"
"0","    mutate(tmp.minute = minute[1] + cumsum(rep(60, n())))"
"0","  dat.TAC$minute[is.na(dat.TAC$minute)] = dat.TAC$tmp.minute[is.na(dat.TAC$minute)]"
"0","  "
"0","  # generate daily steps"
"0","  dat.TAC <- dat.TAC %>%"
"0","    mutate(date = if_else(hour(minute) < 12, as.Date(minute) - 1, as.Date(minute)))"
"0","  TAC_totals <- dat.TAC %>%"
"0","    group_by(date) %>%"
"0","    summarise(TAC = sum(VM_mean),"
"0","              TLAC = sum(log(1+VM_mean)),"
"0","              MVPA = sum(VM_mean >=3940), "
"0","              LPA = sum(VM_mean <3940 & VM_mean >=2860),"
"0","              SED = sum(VM_mean <2860)) %>%"
"0","    mutate(id = sub('.rds', '', file))"
"0","  "
"0","  # generate valid flag"
"0","  wear_flag <- get_wear_flag(dat.TAC$VM_mean)"
"0","  wear_flag_mat <- matrix(wear_flag, ncol = 1440, byrow = TRUE)"
"0","  valid_day_flag <- get_valid_day_flag(wear_flag)"
"0","  valid_day_flag_mat <- matrix(valid_day_flag, ncol = 1440, byrow = TRUE)"
"0","  "
"0","  TAC_totals$valid = apply(valid_day_flag_mat, 1, mean, na.rm = TRUE)"
"0","  TAC_totals = TAC_totals |> mutate(id = sub('[A-Z]' ,'', sub('.rds', '', file))) |>"
"0","    select(-id)"
"0","  "
"0","  # Add Steps to TAC"
"0","  file = sub('_.*', '', sub('[A-Z]' ,'', sub('.rds', '', file)))"
"0","  file.step = files.steps[grepl(file, files.steps)]"
"0","  dat.step = read.csv(paste0('$03_Regenerate.steps.day/', file.step)); dat.step$X = NULL"
"0","  dat.step$date = as.POSIXct(dat.step$Date)"
"0","  "
"0","  dat.TAC.step = merge(TAC_totals, dat.step, by = 'date') |>"
"0","    select(-Date, subjectid, date, TAC, valid, adept, oak, sdt, stepcount, verisence)"
"0","  "
"0","  write.csv(dat.TAC.step, paste0('$05_Combined.Steps.TAC.MVPA.LPA/', file, '.csv'))"
"0","}"
