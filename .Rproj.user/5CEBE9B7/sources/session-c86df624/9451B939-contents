---
title: "Laboratory on: Non-parametric and Semi-parametric Analysis of Survival Times"
author: "AMDACS"
geometry: margin = 1.5cm
output:
  pdf_document: 
    toc: true
    toc_depth: 2
    latex_engine: xelatex
  html_document: default
  word_document: default
mainfont: "Times New Roman"
fontsize: 9pt
header-includes:
  \usepackage{amsmath,latexsym,amsfonts,amsthm}
  \usepackage{fvextra}
  \DefineVerbatimEnvironment{Highlighting}{Verbatim}{breaklines,commandchars=\\\{\}}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(warning = FALSE, echo = TRUE, 
                      tidy.opts = list(width.cutoff = 60), tidy = TRUE)
```

# Learning objectives:

Students who successfully complete this lab should be able to:

1.  Determine the limitations of assumptions of proportionality of hazards.
2.  Model departures of proportionality using interaction terms.
3.  Estimate and interpret hazard ratios under non-proportional hazards.

# Modeling predictor variables of Coronary Heart Disease (CHD) events: The Atherosclerosis Risk in Communities (ARIC) Study, 1987-94

The main goal of the Atherosclerosis Risk in Communities (ARIC) Study was to investigate the etiology and natural history of subclinical atherosclerosis. The study population consisted of 15,800 subjects, ages 45 to 64 years of both sexes, randomly selected from four communities in the U.S. (approximately one fourth from each): selected Minneapolis suburbs, MN, Washington County, MD, Forsyth County, NC, and Jackson, MS. Data for the present exercise were based exclusively on data from the Washington County, MD cohort, where 4,020 participants were initially recruited.

The study objectives, design, sampling procedures, and examination procedures have been described elsewhere (The ARIC investigators: Am J Epidemiol. 1989, 129: 687-702). Briefly, a baseline interview and clinical examination were carried out between the fall of 1986 and winter of 1989; participants were re-interviewed annually by telephone, and reexamined at a clinic visit every three years.

For the present exercise, the outcome of interest is the occurrence of a coronary heart disease (CHD) event from the baseline examination through December 31, 1994. A CHD event is defined as 1) a definite or probable myocardial infarction (MI), 2) a definite CHD death, 3) a coronary revascularization (coronary bypass, angioplasty or coronary atherectomy), or 4) a Q-wave found in the ECG at one of the follow-up visits (silent MI). ARIC events are ascertained through the annual telephone calls, to identify all hospitalizations and deaths. Vital status of non-respondents is ascertained by contacting family members. ARIC staff also surveyed death certificates and discharge lists from local hospitals to detect additional cardiovascular events. ARIC investigated out-of-hospital deaths by means of the death certificate and, in most cases, an interview with next of kin and questionnaires completed by the patient’s physicians. For hospitalized patients, trained abstractors recorded all discharge diagnoses and procedure codes, the presenting signs and symptoms, including chest pain, cardiac enzymes, and related clinical information. Technicians visually coded up to three 12-lead ECGs. An ARIC Morbidity and Mortality Classification Committee then reviewed and adjudicated all potential clinical CHD events.

**Analyze the data by following the instructions on this handout and by running the do file on the course website. The data file aric.dat and the file semi-parametric.R can be found on the content page of CoursePlus.**

We first need to set the working directory, install and load relevant packages:

```{r}
# Note: change the working directory to fit your file path
```

```{r, message = FALSE, results = "hide"}
# Install missing packages, load packages
### {tidyverse} packages for data cleaning, transformation, and plotting
if(!require(tidyverse)) install.packages("tidyverse")
### {lubridate} package to manipulate dates including internally converting mm/dd/yyyy to days from 1/1/1970
if(!require(lubridate)) install.packages("lubridate")
### {survival} package for semi-parametric survival analysis
if(!require(survival)) install.packages("survival")
### {survminer} package to plot survival curves
if(!require(survminer)) install.packages("survminer")
#### Note: for {survminer} package, if the above installation failed, you can install the latest
#### version from GitHub (https://github.com/kassambara/survminer) using `install_github`
#### function in {devtools} package.
#### For Windows users, you may need to have Rtools (https://cran.r-project.org/bin/windows/Rtools/)
#### installed to build the package.
if(!require(devtools)) install.packages("devtools")
if(!require(survminer)) devtools::install_github("kassambara/survminer", build_vignettes = FALSE)
### {lmtest} package to test nested linear models
if(!require(lmtest)) install.packages("lmtest")
### {lmtest} package for linear combination of parameter estimates
if(!require(multcomp)) install.packages("multcomp")
### {gmodels} package for cross-tabulation
if(!require(gmodels)) install.packages("gmodels")
### {broom} package to clean up regression outputs
if(!require(broom)) install.packages("broom")

library(tidyverse)
library(lubridate)
library(survival)
library(survminer)
library(broom)
```

# Part I: Setting up the data file for analysis

The variables in the data file **`aric.dat`** are:

| Variable         | Codebook                                                                                                                    |
|:-----------------------------------|:-----------------------------------|
| `id`             | study id number                                                                                                             |
| `racegrp`        | B(black), W(white), A(asian), I(American Indian)                                                                            |
| `prevchd`        | prevalent CHD at baseline; 0=no, 1=yes                                                                                      |
| `gender`         | F(female), M(male)                                                                                                          |
| `ageatbaseline`  | baseline age, in years                                                                                                      |
| `dateatbaseline` | baseline date; mm/dd/yy                                                                                                     |
| `hypert`         | baseline hypertension status defined as SBP\>140 or DBP\>90 or anti-hypertension medication; 0=no, 1=yes                    |
| `hyptmed`        | baseline anti-hypertension medication use; 0 = no, 1= yes                                                                   |
| `cholmed`        | baseline cholesterol medication use; 0 = no, 1 = yes                                                                        |
| `smoke123`       | baseline cigarette smoking history; 1=current, 2=former, 3=never                                                            |
| `bmi`            | baseline body mass index, in kg/m^2^                                                                                        |
| `birthdat`       | date of birth; mm/dd/yy                                                                                                     |
| `chol`           | baseline serum cholesterol, in mg/dl                                                                                        |
| `sbp`            | baseline systolic blood pressure, in mmHg                                                                                   |
| `dbp`            | baseline diastolic blood pressure, in mmHg                                                                                  |
| `chdevent`       | occurrence of CHD event; 0=no, 1=yes                                                                                        |
| `datechd`        | date of occurrence of CHD event (if CHD event occurred) or last time seen event-free (if CHD event did not occur); mm/dd/yy |
| `enddate`        | end of follow up: 12/31/94, or date of death, or date of CHD event; mm/dd/yy                                                |

Note: Missing data values for the different variables are coded as periods.

### a.

Read the data file in R. Several of the variables (id, racegrp, gender, and all 4 dates) are character variables (i.e., include letters or symbols in addition to numbers), and must be read in as such. To read in the file and name the variables, use the following function:

```{r}
### Note: the `read_table()` function automatically picks class for each variable. In this case, by
### default, only `gender` variable was not processed as desired; thus, I manually forced `gender`
### to be read in as “character” class by setting `col_types` option.
aric <- read_table("aric.dat",
                   col_names = c("id", "racegrp", "prevchd", "gender", "ageatbaseline", "dateatbaseline",
                                 "hypert", "hyptmed", "cholmed", "smoke123", "bmi", "birthdat", "chol", "sbp", "dbp",
                                 "chdevent", "datechd", "enddate"),
                   na = ".",
                   col_types = list(gender = "c"))
```

Reformat the date from character variables, so that dates are stored internally in R as the number of days since January 1, 1970.

```{r}
aric <- aric %>% 
    mutate(across(c("dateatbaseline", "birthdat", "datechd", "enddate"),
                  ~ parse_date_time2(.x, "mdy", cutoff_2000 = 1),
                  .names = "e{col}"))
```

Exclude participants with missing information on smoking status, hypertension, cholesterol, or BMI.

```{r}
aric <- aric %>% drop_na(smoke123, hypert, chol, bmi)
```

### b.

Generate the new variable for follow-up time (time from baseline to either occurrence of CHD event or last time seen event-free) by subtracting one date from another to get an elapsed period of time (in years):

```{r}
aric <- aric %>% 
    mutate(followup = case_when(chdevent == 1 ~ (edatechd-edateatbaseline)/365.25,
                                chdevent == 0 ~ (eenddate-edateatbaseline)/365.25)) %>% 
    mutate(followup = as.numeric(followup))
```

We now have the length of follow-up time stored in the variable **`followup`**.

### c.

Create the variable for the quartiles of BMI separately for males and females. The quartile cutoffs have been identified for you, and the following commands will create an ordinal variable for BMI quartiles, **`bmiquar`**, having values 1, 2, 3 and 4:

```{r}
aric <- aric %>% 
    mutate(bmiquar = ifelse(gender == "F",
                            cut(bmi, c(0, 23.47, 26.893, 31.2, Inf), labels = c(1:4), right = FALSE),   # cutoffs for females
                            cut(bmi, c(0, 24.895, 27.235, 30, Inf), labels = c(1:4), right = FALSE)))   # cutoffs for males
```

Note the above programs works since no one has `gender` missing. Had there been any missingness, those with missing values would have been categorized as males, and to avoid such error, one will need to change the code above.

```{r}
aric %>% with(table(is.na(gender)))   # check if there's missingness for `gender`
```

### d.

Create dummy variables for the quartiles of BMI (e.g., bmiq2 will be 1 if the BMI is in quartile 2, and it is zero otherwise):

```{r}
aric <- aric %>% mutate(bmiq2 = ifelse(bmiquar == 2, 1, 0), bmiq3 = ifelse(bmiquar == 3, 1, 0), bmiq4 = ifelse(bmiquar == 4, 1, 0))
```

### e.

Create an ordinal variable for cholesterol (i.e., 1 if \<200; 2 if between 200 and \<240; and 3 if \>=240):

```{r}
aric <- aric %>% mutate(cholcat = cut(chol, c(0, 200, 240, Inf), labels = c(1, 2, 3), right = FALSE))
```

### f.

The smoking variable is currently defined as 1=current, 2=former, 3=never. Create dummy variables for smoking.

```{r}
aric <- aric %>% mutate(formersmoke = ifelse(smoke123 == 2, 1, 0), currentsmoke = ifelse(smoke123 == 1, 1, 0))
```

### g.

Replace smoke123 with an ordinal variable for smoking with 1 for never smokers, 2 for former smokers and 3 for current smokers:

```{r}
aric <- aric %>% mutate(smoke123 = case_when(smoke123 == 1 ~ 3, smoke123 == 2 ~ 2, smoke123 == 3 ~ 1))
```

### h.

Set the data as survival time data with coronary heart disease as the event of interest by creating the time-to-event survival outcome variable `SurvObj`.

```{r}
aric <- aric %>% mutate(SurvObj = Surv(followup, chdevent))
```

# Part II: Comparison of survival curves and univariate Cox regression

## Question 1.

Plot the Kaplan-Meier survival curves stratified by the main variables of interest: quartiles of BMI, three categories of cholesterol, and smoking as never, former and current.

```{r, fig.width = 7, fig.height = 5, fig.align = 'center'}
### Kaplan-Meier curves stratified by BMI quartiles
ggsurvplot(survfit(SurvObj ~ bmiquar, data = aric), data = aric,
           palette = "lancet", linetype = 1, censor.size = 0.8,
           title = "CHD Event Occurrence by BMI Quartiles", xlab = "Follow-up time (years)",
           ylim = c(0.85, 1), break.x.by = 1,
           legend.title = "BMI quartile",
           legend.labs = c("BMI quartile 1 (lowest BMI)", "BMI quartile 2", 
                           "BMI quartile 3", "BMI quartile 4 (highest BMI)"))
```

```{r, fig.width = 7, fig.height = 5, fig.align = 'center'}
### Kaplan-Meier curves stratified by cholesterol category
ggsurvplot(survfit(SurvObj ~ cholcat, data = aric), data = aric,
           palette = "lancet", linetype = 1, censor.size = 0.8,
           title = "CHD Event Occurrence by Cholesterol Categories", xlab = "Follow-up time (years)",
           ylim = c(0.85, 1), break.x.by = 1,
           legend.title = "Cholesterol",
           legend.labs = c("Cholesterol<200", "200<=Cholesterol<240", "Cholesterol>=240"))
```

```{r, fig.width = 7, fig.height = 5, fig.align = 'center'}
### Kaplan-Meier curves stratified by smoking category
ggsurvplot(survfit(SurvObj ~ smoke123, data = aric), data = aric,
           palette = "lancet", linetype = 1, censor.size = 0.8,
           title = "CHD Event Occurrence by Smoking Categories", xlab = "Follow-up time (years)",
           ylim = c(0.85, 1), break.x.by = 1,
           legend.title = "Smoking Category",
           legend.labs = c("Never", "Former", "Current"))
```

### a.

Interpret the associations depicted by the Kaplan-Meier curves.

$\\ \\ \\ \\ \\ \\ \\ \\$

### b.

Compare the survival curves using the log-rank test. Interpret the results of these tests.

```{r}
### By BMI categories
survdiff(SurvObj ~ bmiquar, data = aric)
```

```{r}
### By cholesterol categories
survdiff(SurvObj ~ cholcat, data = aric)
```

```{r}
### By smoking categories
survdiff(SurvObj ~ smoke123, data = aric)
```

$\\ \\ \\ \\ \\ \\ \\ \\$

## Question 2.

Fit a Cox regression model (Model 1) including only former and current smoking categories as covariates, store the estimates for comparison with other models below and generate two variables with hazard ratios for former to never and current to never smokers.

```{r}
## Fit a Cox regression model to examine the association between smoking and hazard of CHD
### We are going to store the estimates for this model, so that we can do a likelihood ratio test later on in the lab
model1 <- coxph(SurvObj ~ formersmoke + currentsmoke, data = aric, method = "breslow")
summary(model1)
```

```{r}
# Generates value of HR for former to never smokers and for current to never smokers to be used in a plot in question 4
aric <- aric %>% 
    mutate(CoxHRFormertoNever = ifelse(formersmoke == 1, 
                                       exp(model1$coefficients["formersmoke"]), 
                                       as.numeric(NA)),
           CoxHRCurrenttoNever = ifelse(currentsmoke == 1, 
                                        exp(model1$coefficients["currentsmoke"]), 
                                        as.numeric(NA)))
```

### a.

Interpret the numerical values of the regression coefficients from the model.

$\\ \\$

### b.

Obtain the corresponding relative hazards and 95% confidence intervals.

$\\ \\ \\ \\$

### c.

Do these results fit your expectations based on the non-parametric survival curves for the three smoking categories?

$\\ \\$

## Question 3.

What assumption needs to be fulfilled for the results in question 2 to be valid? Do the Kaplan-Meier curves shown in question 1 need the same assumption? And, what about for the logrank tests? (Recall that the logrank test is the same as the Mantel-Haenszel test to combine 2x2 tables and what assumption is expected for the odds ratio?)

$\\ \\ \\ \\$

## Question 4.

Fit a Cox regression model where we include only smoking categories as covariates, but also allowing the hazards of the smoking categories to be non-proportional over time (Model 2). Compute values of AIC and BIC.

```{r}
### Model 2: Fit a Cox regression model to examine the association between smoking and hazard of CHD, allowing
### for the hazards of the smoking categories to be non-proportional over time
model_attempt <- coxph(SurvObj ~ formersmoke + currentsmoke + 
                         tt(formersmoke) + tt(currentsmoke),
                       data = aric, tt = function(x, t, ...) x * t, 
                       method = "breslow")
summary(model_attempt)
```

```{r}
glance(model_attempt) %>% dplyr::select(n, nevent, logLik, AIC, BIC, nobs) %>% knitr::kable()
```

Both `tt()` estimates are negative. Now try a linear spline model with a constant relative hazard after 7.1, the 75th percentile of all the measurements of time to event.

**`tt(formersmoke)` and `tt(currentsmoke)`**: These are the time-transformed versions of the covariates, specified by the function `tt = function(x, t, ...) x * t`. This indicates that the model includes both the baseline effect of smoking status and an additional component that represents the interaction of smoking status with time.

```{r}
### Determine the 75th percentile of the times which is close to 7.1 in order to fit a restricted spline with this as the knot
# hazard is constant after time = 7.1
summary(aric$followup)
```

```{r}
model2 <- coxph(SurvObj ~ formersmoke + currentsmoke 
                + tt(formersmoke) + tt(currentsmoke),
                data = aric, tt = function(x, t, ...) x * (t-7.1) * (t<=7.1), 
                method = "breslow")
summary(model2)
```

```{r}
glance(model2) %>% dplyr::select(n, nevent, logLik, AIC, BIC, nobs) %>% knitr::kable()
```

### a.

Which non-proportional hazards model is preferred?

**The second model is preferred.**

1) The hazard ratio of smoking status is not fixed from previous study, and according to survival bias, we might expect people who smoke are more healthier than those who not smoke at the same age.

### b.

Use the likelihood ratio test to assess the proportionality of the smoking hazards over time by comparing model 2 (non-proportional) to model 1 (proportional hazards). Do the results suggest that the hazards of CHD by smoking categories are non-proportional?

```{r}
### Does proportionality hold?
lmtest::lrtest(model2, model1)
```

The significance suggest non-proportional model might be better.

### c.

Are the former smokers at a significantly higher hazard than the non-smokers at baseline (i.e., at time = 0)?

```{r}
multcomp::glht(model2, linfct = c("formersmoke + `tt(formersmoke)`*(0-7.1) = 0")) %>% 
    tidy(conf.int = TRUE) %>% 
    mutate(across(c("estimate", "conf.low", "conf.high"), ~ exp(.x))) %>% 
    knitr::kable()   # relative hazard
```

**`multcomp::glht` Function**: This function from the `multcomp` package is used to perform general linear hypothesis tests. It's applied to a fitted model (`model2` in this case) to test linear combinations of model parameters. In survival analysis, it can be used to test hypotheses about the relative hazard associated with specific covariates or their interactions.

-   `"formersmoke +`tt(formersmoke)`*(0-7.1) = 0"`: This specifies a hypothesis about the combined effect of the `formersmoke` variable and its time-dependent component `tt(formersmoke)`.

-   `tt(formersmoke)` is a time-dependent effect that changes over time. Here, it's multiplied by the difference `(0-7.1)`, which suggests you are testing the linear combination of the baseline effect of `formersmoke` and the effect of time at `t = 7.1`.

-   The hypothesis being tested is whether this combination equals 0, which is a test for whether the relative hazard associated with `formersmoke` changes significantly over time at `t = 7.1`.

Multiplying `tt(formersmoke)` by `(0-7.1)` means you are assessing how the effect of `formersmoke` has changed over a period of 7.1 time units from the baseline.

**Answer:** significantly changed

### d.

Are current and former smokers at similar hazard at baseline?

```{r}
multcomp::glht(model2, linfct = c("currentsmoke + `tt(currentsmoke)`*(0-7.1) - (formersmoke + `tt(formersmoke)`*(0-7.1)) = 0")) %>% 
    tidy(conf.int = TRUE) %>% 
    mutate(across(c("estimate", "conf.low", "conf.high"), ~ exp(.x))) %>% 
    mutate(across(c("estimate", "conf.low", "conf.high", "statistic", "adj.p.value"), ~ round(.x, 3))) %>% 
    knitr::kable()   # relative hazard
```

**Answer:** Not changed significantly.

### e.

Does the relative hazard of former to never smokers significantly change at four years when compared to the relative hazard at baseline?

```{r}
multcomp::glht(model2, linfct = c("formersmoke + `tt(formersmoke)`*(4-7.1) = 0")) %>% 
    tidy(conf.int = TRUE) %>% 
    mutate(across(c("estimate", "conf.low", "conf.high"), ~ exp(.x))) %>% 
    knitr::kable()   # relative hazard
```

**Answer:** changed significantly.

### f.

Are current smokers worst off than former smokers at 4 years after baseline? Is there a directionality change of the relative hazard (current to former) from baseline to 4 years after baseline?

```{r}
multcomp::glht(model2, linfct = c("currentsmoke + `tt(currentsmoke)`*(4-7.1) - (formersmoke + `tt(formersmoke)`*(4-7.1)) = 0")) %>% 
    tidy(conf.int = TRUE) %>% 
    mutate(across(c("estimate", "conf.low", "conf.high"), ~ exp(.x))) %>% 
    mutate(across(c("estimate", "conf.low", "conf.high", "statistic", "adj.p.value"), ~ round(.x, 3))) %>% 
    knitr::kable()   # relative hazard
```

**Answer:** Not changed significantly.

### g.

Interpret the `tt` “hazard ratio” numerical values of “0.812” and “0.898” from the R output for the Cox regression model modeling non-proportionality with a linear spline (model 2) comparing former smokers to never smokers and current smokers to never smokers.

```{r}
summary(model2)
```

**Answer**:

-   **tt(formersmoke):** represents the time-dependent hazard ratio associated with being a former smoker compared to a never smoker. It indicates the hazard of former smoker decreases as time increases.

-   **0.812:** For each unit increase in time (after the initial period defined by the time transformation), the hazard for former smokers is multiplied by 0.812, indicating a decreasing trend in risk over time.

```{=html}
<!-- -->
```
-   **Compare 0.812 and 0.898:** the risk of the event **decreases** over time for current smokers compared to never smokers. However, the effect is less pronounced compared to former smokers (since 0.898 is closer to 1 than 0.812).

### h.

Generate hazard ratios based on the non-proportional hazards model (model 2) and produce a plot comparing them with the results from model 1 assuming proportionality of hazards. Is there agreement between the model assuming proportionality of hazards (model 1) and the model allowing for the hazard ratios to change linearly with time for the first 7.1 years (model 2) in the log scale?

```{r, fig.width = 6, fig.height = 4, fig.align = 'center'}
### Generates HR for former to never smokers and for current to never smokers
aric <- aric %>% 
    mutate(CoxtvcHRFormertoNever = ifelse(formersmoke == 1,
                                          exp(model2$coefficients["formersmoke"] + model2$coefficients["tt(formersmoke)"] * (followup-7.1)*(followup<=7.1)),
                                          as.numeric(NA)),
           CoxtvcHRCurrenttoNever = ifelse(currentsmoke == 1,
                                           exp(model2$coefficients["currentsmoke"] + model2$coefficients["tt(currentsmoke)"] * (followup-7.1)*(followup<=7.1)),
                                           as.numeric(NA)))
```

```{r}
aric %>% 
    dplyr::select(followup, contains("Cox")) %>% 
    pivot_longer(col = -followup, names_to = "HR", values_to = "value") %>% 
    ggplot(aes(x = followup, color = HR)) +
    geom_point(aes(y = value)) +
    geom_hline(yintercept = 1) +
    xlab("Years after baseline") +
    ylab("HR") +
    scale_color_manual("", values = c("#267532", "#2E3075", "#3EC252", "#4D50C3"),
                       labels = c("HR of Current vs Never", "HR of Former vs Never",
                                  "Time-varying HR of Current vs Never", "Time-varying HR of Former vs Never")) +
    theme_minimal() +
    theme(legend.position = "bottom") +
    guides(color = guide_legend(nrow = 2)) 
```

**Answer:** No agreement between Model 1 and Model 2. We can notice that HRs of current smoker or former smoker decrease obviously in the first 7.1 years than never smoker. And the initial and final HRs compared to fixed HR in Model 1.

**The figure illustrates** the hazard ratios (HR) comparing current and former smokers to never smokers over time, based on the adjusted non-proportional hazards model. In the adjusted model, the time-varying HRs for both current and former smokers decrease over time. For current smokers, the risk of CHD starts high, gradually decreasing but remaining elevated throughout the study period. Conversely, the risk for former smokers decreases more rapidly, becoming non-significant after approximately four years. This contrasts with the assumption of proportional hazards, where the risks would remain constant over time.

# Part III: Multivariate analysis including smoking, age, gender, hypertension, cholesterol, and BMI

In the following multivariate analyses, we will fit Cox regression models for smoking with covariates for baseline age, gender, baseline hypertension status, baseline cholesterol, and baseline BMI. Since there is a dose-response in the cholesterol categories and survival until CHD event based on the Kaplan-Meier curves (question 1), we are going to model cholesterol as a continuous variable. In the Kaplan-Meier survival curves in question 1, we saw that the survival curves for the third and fourth BMI quartiles were very similar. As a result, for our regression analyses we are going to collapse the third and fourth BMI quartiles into one category. Since the relationship between BMI quartiles and survival does not appear linear based on the Kaplan-Meier survival curves, we will code BMI categories using dummy variables in the model.

## Question 5.

Collapse the third and fourth BMI quartiles into one category

```{r}
### Collapse the third and fourth BMI quartiles into one category
aric <- aric %>% 
    mutate(bmi123 = case_when(bmiquar == 1 ~ 1, bmiquar == 2 ~ 2, bmiquar == 3 | bmiquar == 4 ~ 3))
aric <- aric %>% mutate(bmiq3_4 = ifelse(bmiquar == 3 | bmiquar == 4, 1, 0))
```

Fit a multivariate model (Model 3) with covariates for smoking age, gender, hypertension, cholesterol, and BMI, assuming proportionality of hazards.

```{r}
model3 <- coxph(SurvObj ~ formersmoke + currentsmoke + ageatbaseline + factor(gender) + hypert + chol + factor(bmi123),
                data = aric, method = "breslow")
summary(model3)
```

Generate HR for former to never smokers and for current to never smokers.

```{r}
aric <- aric %>% 
    mutate(CoxAdjHRFormertoNever = ifelse(formersmoke == 1, exp(model3$coefficients["formersmoke"]), as.numeric(NA)),
           CoxAdjHRCurrenttoNever = ifelse(currentsmoke == 1, exp(model3$coefficients["currentsmoke"]), as.numeric(NA)))
```

Interpret the hazard ratios for the two smoking categories, cholesterol and BMI. Compare the adjusted hazard ratios for the smoking categories from this model to the hazard ratios from the unadjusted model.

$\\ \\ \\ \\ \\ \\ \\ \\$

## Question 6.

To characterize the changes of the effect of smoking due to the adjustment by other factors, provide descriptive statistics of the other factors in the three groups of smokers (never, former and current) and to identify the changes due to each factor carry out five models each one having one of the five factors along with the two indicators for former and current smokers.

```{r}
aric %>% 
    group_by(smoke123) %>% 
    summarise(Obs = n(), Mean = mean(ageatbaseline), SD = sd(ageatbaseline), min = min(ageatbaseline), max = max(ageatbaseline))
```

```{r}
coxph(SurvObj ~ formersmoke + currentsmoke + ageatbaseline, data = aric, method = "breslow") %>% summary()
```

```{r}
gmodels::CrossTable(aric$smoke123, aric$gender)
```

```{r}
coxph(SurvObj ~ formersmoke + currentsmoke + factor(gender), data = aric, method = "breslow") %>% summary()
```

```{r}
gmodels::CrossTable(aric$smoke123, aric$hypert)
```

```{r}
coxph(SurvObj ~ formersmoke + currentsmoke + hypert, data = aric, method = "breslow") %>% summary()
```

```{r}
aric %>% 
    group_by(smoke123) %>% 
    summarise(Obs = n(), Mean = mean(chol), SD = sd(chol), min = min(chol), max = max(chol))
```

```{r}
coxph(SurvObj ~ formersmoke + currentsmoke + chol, data = aric, method = "breslow") %>% summary()
```

```{r}
gmodels::CrossTable(aric$smoke123, aric$bmi123)
```

```{r}
coxph(SurvObj ~ formersmoke + currentsmoke + factor(bmi123), data = aric, method = "breslow") %>% summary()
```

What are the major covariate differences among the three groups of smokers? Of the five models (each with one of the different covariates), which one has the strongest effect on the coefficients for former and current smokers?

$\\ \\ \\ \\ \\ \\ \\ \\$

## Question 7.

Fit a Cox regression model including covariates for smoking, age, gender, hypertension, cholesterol and BMI allowing for the hazards of the smoking categories to be non-proportional over time (Model 4).

```{r}
model4 <- coxph(SurvObj ~ formersmoke + currentsmoke + ageatbaseline + factor(gender) + hypert + chol + factor(bmi123) 
                + tt(formersmoke) + tt(currentsmoke),
                data = aric, tt = function(x, t, ...) x * (t-7.1) * (t<=7.1), method = "breslow")
summary(model4)
```

### a.

Do the results suggest that the hazards for the smoking categories are non-proportional?

$\\ \\ \\$

### b.

Using the estimates of the relative hazard of former to never smokers at 4 years after baseline, contrast the inferences of the adjusted model with that of the unadjusted model in question 4e.

```{r}
multcomp::glht(model4, linfct = c("formersmoke + `tt(formersmoke)`*(4-7.1) = 0")) %>% 
    tidy(conf.int = TRUE) %>% 
    mutate(across(c("estimate", "conf.low", "conf.high"), ~ exp(.x))) %>% 
    knitr::kable()   # relative hazard
```

$\\ \\ \\$

### c.

What about the adjusted vs unadjusted (in 4f) relative hazard of current to former smokers at 4 years after baseline?

```{r}
multcomp::glht(model4, linfct = c("currentsmoke + `tt(currentsmoke)`*(4-7.1) - (formersmoke + `tt(formersmoke)`*(4-7.1)) = 0")) %>% 
    tidy(conf.int = TRUE) %>% 
    mutate(across(c("estimate", "conf.low", "conf.high"), ~ exp(.x))) %>% 
    mutate(across(c("estimate", "conf.low", "conf.high", "statistic"), ~ round(.x, 3))) %>% 
    knitr::kable()   # relative hazard
```

$\\ \\ \\$

### d.

Compare the inferences regarding the relationship between baseline smoking status and CHD risk at four years after the baseline visit with those at the baseline visit?

```{r}
multcomp::glht(model4, linfct = c("formersmoke + `tt(formersmoke)`*(0-7.1) = 0")) %>% 
    tidy(conf.int = TRUE) %>% 
    mutate(across(c("estimate", "conf.low", "conf.high"), ~ exp(.x))) %>% 
    knitr::kable()   # relative hazard
```

```{r}
multcomp::glht(model4, linfct = c("currentsmoke + `tt(currentsmoke)`*(0-7.1) - (formersmoke + `tt(formersmoke)`*(0-7.1)) = 0")) %>% 
    tidy(conf.int = TRUE) %>% 
    mutate(across(c("estimate", "conf.low", "conf.high"), ~ exp(.x))) %>% 
    mutate(across(c("estimate", "conf.low", "conf.high", "statistic", "adj.p.value"), ~ round(.x, 3))) %>% 
    knitr::kable()   # relative hazard
```

$\\ \\ \\ \\ \\ \\ \\ \\$

### e.

Generate hazard ratios based on the adjusted non-proportional hazards model and produce a plot to compare them with the adjusted results assuming proportionality of hazards

```{r}
### Generates HR for former to never smokers and for current to never smokers
aric <- aric %>% 
    mutate(CoxAdjtvcHRFormertoNever = ifelse(formersmoke == 1,
                                             exp(model4$coefficients["formersmoke"] + model4$coefficients["tt(formersmoke)"] * (followup-7.1)*(followup<=7.1)),
                                             as.numeric(NA)),
           CoxAdjtvcHRCurrenttoNever = ifelse(currentsmoke == 1,
                                              exp(model4$coefficients["currentsmoke"] + model4$coefficients["tt(currentsmoke)"] * (followup-7.1)*(followup<=7.1)),
                                              as.numeric(NA)))
```

```{r}
aric %>% 
    dplyr::select(followup, contains("CoxAdj")) %>% 
    pivot_longer(col = -followup, names_to = "HR", values_to = "value") %>% 
    ggplot(aes(x = followup, color = HR)) +
    geom_point(aes(y = value)) +
    geom_hline(yintercept = 1) +
    xlab("Years after baseline") +
    ylab("HR") +
    scale_color_manual("", values = c("#267532", "#2E3075", "#3EC252", "#4D50C3"),
                       labels = c("HR of Current vs Never", "HR of Former vs Never",
                                  "Time-varying HR of Current vs Never", "Time-varying HR of Former vs Never")) +
    theme_minimal() +
    theme(legend.position = "bottom") +
    guides(color = guide_legend(nrow = 2))
```

Write a short paragraph (in the flavor of a discussion section of a manuscript) to highlight the pitfalls of assuming proportionality and lack of adjustment in univariate analyses.

$\\ \\ \\ \\ \\ \\ \\ \\$

## Question 8.

From the non-parametric survival curves generated in question 1, you may have noticed that the hazards of CHD for the BMI categories do not seem to be proportional. Therefore, we will fit a multivariate model allowing for non-proportionality in the hazards for both the smoking categories and BMI categories (Model 5).

```{r}
coxph(SurvObj ~ formersmoke + currentsmoke + ageatbaseline + factor(gender) + hypert + chol + bmiq2 + bmiq3_4 
      + tt(formersmoke) + tt(currentsmoke) + tt(bmiq2) + tt(bmiq3_4),
      data = aric, tt = function(x, t, ...) x * (t-7.1) * (t<=7.1), method = "breslow") %>% 
    summary()
```

### a.

Are the model results suggestive of non-proportionality in the BMI category hazards?

$\\ \\$

### b.

How does the relative hazard comparing BMI quartile 2 to BMI quartile 1 change as the time from the baseline visit increases?

$\\ \\ \\ \\$

**Remark**: The dataset for this lab to describe predictors of occurrence of CHD events included 253 individuals with history of CHD (i.e., prevchd==1) and 147 individuals with missing information on history of CHD (i.e., prevchd==.). You may want to rerun the analysis excluding these individuals and determine whether findings described here remain the same after the exclusion.
